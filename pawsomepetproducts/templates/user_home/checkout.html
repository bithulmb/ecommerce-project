{% extends 'base.html' %}

{% block csslinking %}

<script>

$('#new-address-form').submit(function(event){
    event.preventDefault();  // Prevent form from submitting the default way

    $.ajax({
        type: 'POST',
        url: '{% url "add_address_order" %}',
        data: $(this).serialize(),
        success: function(response){
            // Handle success, perhaps reload the page or update the address list
            location.reload();  // Reload page to see new address
        },
        error: function(response){
            // Handle error
            alert("Failed to add address.");
        }
    });
});

</script>


{% endblock %}





{% block content %}
{% load static %}
{% load crispy_forms_tags %}
<section class="section-content padding-y bg">
    <div class="container">
        <div class="row">
            <main class="col-md-8">
                <article class="card mb-4">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Cart Summary</h4>
                        <div class="row">
                            <table class="table align-bottom table-borderless table-shopping-cart">
                                <thead class="text-muted">
                                    <tr class="small text-uppercase">
                                        <th scope="col">Product</th>
                                        <th scope="col" width="120">Quantity</th>
                                        <th scope="col" width="120">Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cart_item in cart_items %}
                                    <tr>
                                        <td class="align-top">
                                            <figure class="itemside align-items-center">
                                                <div class="aside"><img src="{{cart_item.variant.thumbnail.url}}" class="img-sm"></div>
                                                <figcaption class="info">
                                                    <a href="{% url 'single_product_page' cart_item.variant.id %}" class="title text-dark">{{cart_item.variant.product_name}}</a>
                                                    <p class="text-muted small">Size: {{cart_item.variant.size}}</p>
                                                </figcaption>
                                            </figure>
                                        </td>
                                        <td class="align-center"> 
                                            <div class="col">                                   
                                                <h6>{{cart_item.quantity}}</h6>                                      
                                            </div>
                                        </td>
                                        <td> 
                                            <div class="price-wrap"> 
                                                <var class="price">₹ {{cart_item.sub_total}}</var> 
                                                <small class="text-muted"> ₹ {{cart_item.variant.price}} each </small> 
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </article>

                <article class="card mb-4">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Select Address</h4>
                        <div class="row">
                            <form id="order-form" action="{% url 'place_order' %}" method="POST">
                                {% csrf_token %}
                                <div class="row">
                                    {% for address in addresses %}
                                    <div class="col-md-4">
                                        <div class="card mb-3" style="height: 180px;">
                                            <div class="card-body" style="height: 100%;">
                                                <input type="radio" id="address{{address.id}}" name="address_id" value="{{address.id}}" required>
                                                <label for="address{{address.id}}">
                                                    <div>
                                                        <address>
                                                            {{address.name}}, {{address.address_line1}}, {{address.address_line2}}, 
                                                            {{address.town}}, {{address.city}}, {{address.state}} - {{address.pincode}}<br>
                                                            Contact - {{address.contact_number}}
                                                        </address>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <a href="{% url 'add_address_order' %}"><p class="h5 my-4">Add A New Address</p></a>

                    </div>
                </article>
            </main>

            <aside class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <dl class="dlist-align">
                            <dt>Order Amount: </dt>
                            <dd class="text-right">₹ {{total}}</dd>
                        </dl>
                        <dl class="dlist-align">
                            <dt>Shipping Charge:</dt>
                            <dd class="text-right">₹ {{shipping_charge}} </dd>
                        </dl>
                        <dl class="dlist-align">
                            <dt> Total Amount to be paid</dt>
                            <dd class="text-right text-dark b"><strong>₹ {{grand_total}}</strong></dd>
                        </dl>
                        <hr>
                        <p class="text-center mb-3">
                            <img src="{% static 'user/images/misc/payments.png' %}" height="26">
                        </p>
                        <header><h4 class="card-title my-4">Select Payment Method</h4></header>
                        <div class="m-3">
                            <input type="radio" name="payment_method" id="cash_on_delivery" value="cash_on_delivery" required>
                            <label for="cash_on_delivery">Cash On Delivery</label><br>
                        </div>
                        <div class="m-3">
                            <input type="radio" name="payment_method" id="online" value="online" required>
                            <label for="online">Online</label><br>
                        </div>
                        <button type="submit" form="order-form" class="btn btn-primary btn-block">Continue</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</section>

{% endblock %}    